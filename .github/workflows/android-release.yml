name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  core-smoke-test:
    name: Core Smoke Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build Celeste.Core
        run: dotnet build "src/Celeste.Core/Celeste.Core.csproj" -c Release

  build-android-apk:
    name: Build Android APK
    runs-on: windows-latest
    needs: core-smoke-test
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
    env:
      APP_VERSION_CODE: ${{ format('{0}{1}', github.run_number, github.run_attempt) }}
      APP_VERSION_NAME: ${{ format('1.0.{0}.{1}', github.run_number, github.run_attempt) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Validate release signing secrets
        shell: pwsh
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          $required = @("ANDROID_KEYSTORE_BASE64", "ANDROID_KEYSTORE_PASSWORD", "ANDROID_KEY_ALIAS", "ANDROID_KEY_PASSWORD")
          $missing = @()
          foreach ($name in $required) {
            if ([string]::IsNullOrWhiteSpace((Get-Item -Path "Env:$name").Value)) {
              $missing += $name
            }
          }

          if ($missing.Count -gt 0) {
            throw "Missing required signing secrets: $($missing -join ', '). Configure them in repository settings to allow in-place APK updates without uninstall."
          }

      - name: Prepare Android keystore
        shell: pwsh
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          $keystorePath = Join-Path $env:RUNNER_TEMP "release.keystore"
          [System.IO.File]::WriteAllBytes($keystorePath, [System.Convert]::FromBase64String($env:ANDROID_KEYSTORE_BASE64))
          "ANDROID_KEYSTORE_PATH=$keystorePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Show resolved app version
        shell: pwsh
        run: |
          Write-Host "ApplicationVersion=$env:APP_VERSION_CODE"
          Write-Host "ApplicationDisplayVersion=$env:APP_VERSION_NAME"

      - name: Install Android workload
        run: dotnet workload install android

      - name: Restore solution
        run: dotnet restore "Celeste.AndroidPort.sln"

      - name: Validate ABI configuration
        shell: pwsh
        run: |
          [xml]$csproj = Get-Content "${{ github.workspace }}\src\Celeste.Android\Celeste.Android.csproj"
          $runtimeIds = $csproj.Project.PropertyGroup.RuntimeIdentifiers
          if (-not $runtimeIds) {
            throw "RuntimeIdentifiers not configured"
          }

          if ($runtimeIds -notmatch "android-arm" -or $runtimeIds -notmatch "android-arm64") {
            throw "Expected RuntimeIdentifiers android-arm and android-arm64, got: $runtimeIds"
          }

          Write-Host "RuntimeIdentifiers validated: $runtimeIds"

      - name: Build signed APK
        shell: pwsh
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          dotnet publish "src/Celeste.Android/Celeste.Android.csproj" `
            -c Release `
            -f net9.0-android `
            -p:AndroidPackageFormat=apk `
            -p:ApplicationVersion=$env:APP_VERSION_CODE `
            -p:ApplicationDisplayVersion=$env:APP_VERSION_NAME `
            -p:AndroidKeyStore=true `
            -p:AndroidSigningKeyStore="$env:ANDROID_KEYSTORE_PATH" `
            -p:AndroidSigningStorePass="$env:ANDROID_KEYSTORE_PASSWORD" `
            -p:AndroidSigningKeyAlias="$env:ANDROID_KEY_ALIAS" `
            -p:AndroidSigningKeyPass="$env:ANDROID_KEY_PASSWORD"

      - name: Collect artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "${{ github.workspace }}\artifacts" -Force | Out-Null
          $apks = Get-ChildItem -Path "${{ github.workspace }}\src\Celeste.Android\bin\Release\net9.0-android" -Recurse -Filter *.apk
          if (-not $apks -or $apks.Count -eq 0) {
            throw "No APK artifact found after publish"
          }

          $apks | Copy-Item -Destination "${{ github.workspace }}\artifacts" -Force

      - name: Upload Android APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: ${{ github.workspace }}\artifacts\*.apk
